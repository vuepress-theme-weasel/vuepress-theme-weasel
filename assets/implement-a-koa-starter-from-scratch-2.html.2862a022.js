import{_ as e,r as o,o as c,c as i,a as n,b as t,F as l,d as s,e as p}from"./app.f3af98d4.js";const u={},r=n("h2",{id:"\u672C\u8282\u76EE\u6807",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u672C\u8282\u76EE\u6807","aria-hidden":"true"},"#"),s(" \u672C\u8282\u76EE\u6807")],-1),k=s("\u672C\u8282\u76EE\u6807\u662F\u5B9E\u73B0\u4E00\u4E2A\u7B80\u5355\u7684\u8DEF\u7531\u81EA\u52A8\u88C5\u8F7D\u670D\u52A1\u7AEF\uFF0C\u5305\u542B\u5B8C\u6574\u88C5\u8F7D\u65E5\u5FD7\uFF0C\u8BF7\u6C42\u65E5\u5FD7\uFF0C\u81EA\u52A8\u7ED1\u5B9Acontroller\u5230\u8DEF\u7531\uFF0C\u53EA\u9700\u6309\u7167\u62BD\u8C61\u7C7B\u4E66\u5199controller\u5373\u53EF\u3002\u5148\u4E0A\u3010"),d={href:"https://github.com/CavinHuang/koa-starter/tree/koa-router-1",target:"_blank",rel:"noopener noreferrer"},v=s("GitHub\u5730\u5740"),m=s("\u3011"),b=n("h2",{id:"\u5E94\u7528\u670D\u52A1\u7684\u57FA\u672C\u5C01\u88C5",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u5E94\u7528\u670D\u52A1\u7684\u57FA\u672C\u5C01\u88C5","aria-hidden":"true"},"#"),s(" \u5E94\u7528\u670D\u52A1\u7684\u57FA\u672C\u5C01\u88C5")],-1),g=n("h3",{id:"\u4EC0\u4E48\u662Fkoa",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u4EC0\u4E48\u662Fkoa","aria-hidden":"true"},"#"),s(" \u4EC0\u4E48\u662Fkoa\uFF1F")],-1),y={href:"http://koajs.cn/",target:"_blank",rel:"noopener noreferrer"},w=s("Koa"),f=s(" \u662F\u4E0B\u4E00\u4EE3\u7684 Node.js \u7684 Web \u6846\u67B6\u3002\u7531 Express \u56E2\u961F\u8BBE\u8BA1\u3002\u65E8\u5728\u63D0\u4F9B\u4E00\u4E2A\u66F4\u5C0F\u578B\u3001\u66F4\u5BCC\u6709\u8868\u73B0\u529B\u3001\u66F4\u53EF\u9760\u7684 Web \u5E94\u7528\u548C API \u7684\u5F00\u53D1\u57FA\u7840\u3002\u5B83\u7684\u7279\u70B9\u662F\u4F18\u96C5\u3001\u7B80\u6D01\u3001\u8868\u8FBE\u529B\u5F3A\u3001\u81EA\u7531\u5EA6\u9AD8\u3002\u8DDFexpress\u76F8\u6BD4\uFF0C\u5B83\u662F\u4E00\u4E2A\u66F4\u8F7B\u91CF\u7684node\u6846\u67B6\uFF0C\u56E0\u4E3A\u5B83\u6240\u6709\u529F\u80FD\u90FD\u901A\u8FC7\u63D2\u4EF6\u5B9E\u73B0\uFF0C\u8FD9\u79CD\u63D2\u62D4\u5F0F\u7684\u67B6\u6784\u8BBE\u8BA1\u6A21\u5F0F\u3002"),h=p(`<h3 id="koa\u7684\u56DB\u5927\u6A21\u5757" tabindex="-1"><a class="header-anchor" href="#koa\u7684\u56DB\u5927\u6A21\u5757" aria-hidden="true">#</a> koa\u7684\u56DB\u5927\u6A21\u5757</h3><ul><li>\u5C01\u88C5node http server\u3001\u521B\u5EFAKoa\u7C7B\u6784\u9020\u51FD\u6570</li><li>\u6784\u9020request\u3001response\u3001context\u5BF9\u8C61</li><li>\u4E2D\u95F4\u4EF6\u673A\u5236\u548C\u5265\u6D0B\u8471\u6A21\u578B</li><li>\u9519\u8BEF\u6355\u83B7\u548C\u9519\u8BEF\u5904\u7406</li></ul><h3 id="koa\u4E2D\u95F4\u4EF6\u673A\u5236" tabindex="-1"><a class="header-anchor" href="#koa\u4E2D\u95F4\u4EF6\u673A\u5236" aria-hidden="true">#</a> koa\u4E2D\u95F4\u4EF6\u673A\u5236</h3><p>\u591A\u4E2A\u4E2D\u95F4\u4EF6\u4F1A\u5F62\u6210\u4E00\u4E2A\u6808\u7ED3\u6784\uFF08middle stack\uFF09\uFF0C\u4EE5&quot;\u5148\u8FDB\u540E\u51FA&quot;\uFF08first-in-last-out\uFF09\u7684\u987A\u5E8F\u6267\u884C\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u6700\u5916\u5C42\u7684\u4E2D\u95F4\u4EF6\u9996\u5148\u6267\u884C\u3002
\u8C03\u7528next\u51FD\u6570\uFF0C\u628A\u6267\u884C\u6743\u4EA4\u7ED9\u4E0B\u4E00\u4E2A\u4E2D\u95F4\u4EF6\u3002
...
\u6700\u5185\u5C42\u7684\u4E2D\u95F4\u4EF6\u6700\u540E\u6267\u884C\u3002
\u6267\u884C\u7ED3\u675F\u540E\uFF0C\u628A\u6267\u884C\u6743\u4EA4\u56DE\u4E0A\u4E00\u5C42\u7684\u4E2D\u95F4\u4EF6\u3002
...
\u6700\u5916\u5C42\u7684\u4E2D\u95F4\u4EF6\u6536\u56DE\u6267\u884C\u6743\u4E4B\u540E\uFF0C\u6267\u884Cnext\u51FD\u6570\u540E\u9762\u7684\u4EE3\u7801
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5),x=s("\u66F4\u591A\u5173\u4E8Ekoa\u7684\u4ECB\u7ECD\uFF0C\u63A8\u8350\u962E\u4E00\u5CF0\u5927\u795E\u7684"),_={href:"http://www.ruanyifeng.com/blog/2017/08/koa.html",target:"_blank",rel:"noopener noreferrer"},C=s("koa \u6846\u67B6\u6559\u7A0B"),A=s("\uFF0C\u5173\u4E8Ekoa\u7684\u6D0B\u8471\u6A21\u578B\uFF0C\u63A8\u8350\u770B\u8FD9\u7247\u6587\u7AE0"),q={href:"https://juejin.cn/post/7012031464237694983",target:"_blank",rel:"noopener noreferrer"},L=s("Gopal -\u3010Node\u3011\u6DF1\u5165\u6D45\u51FA Koa \u7684\u6D0B\u8471\u6A21\u578B"),T=p(`<h3 id="\u542F\u52A8\u4E00\u4E2A\u6700\u7B80\u5355\u7684koa\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u542F\u52A8\u4E00\u4E2A\u6700\u7B80\u5355\u7684koa\u670D\u52A1" aria-hidden="true">#</a> \u542F\u52A8\u4E00\u4E2A\u6700\u7B80\u5355\u7684koa\u670D\u52A1</h3><p>\u5982\u4E0B\u4EE3\u7801\uFF1A</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">&#39;koa&#39;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;hello koa!&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\u670D\u52A1\u542F\u52A8\u4E86\uFF01&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F7F\u7528 ts-node \u8DD1\u8D77\u6765\u540E\uFF0C\u8BBF\u95EE http://127.0.0.1:3000 \u65F6\uFF0C\u5C31\u4F1A\u5F97\u5230 hello koa\uFF01 \u7684\u8F93\u51FA\u4E86\u3002</p><p>Koa \u5E94\u7528\u7A0B\u5E8F\u4E0D\u662F HTTP \u670D\u52A1\u5668\u76841\u5BF91\u5C55\u73B0\u3002 \u53EF\u4EE5\u5C06\u4E00\u4E2A\u6216\u591A\u4E2A Koa \u5E94\u7528\u7A0B\u5E8F\u5B89\u88C5\u5728\u4E00\u8D77\u4EE5\u5F62\u6210\u5177\u6709\u5355\u4E2AHTTP\u670D\u52A1\u5668\u7684\u66F4\u5927\u5E94\u7528\u7A0B\u5E8F\u3002\u8FD9\u91CC\u7684 app.listen(...) \u65B9\u6CD5\u53EA\u662F\u4EE5\u4E0B\u65B9\u6CD5\u7684\u8BED\u6CD5\u7CD6:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">&#39;http&#39;</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\u670D\u52A1\u542F\u52A8\u4E86\uFF01&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u610F\u5473\u7740\u60A8\u53EF\u4EE5\u5C06\u540C\u4E00\u4E2A\u5E94\u7528\u7A0B\u5E8F\u540C\u65F6\u4F5C\u4E3A HTTP \u548C HTTPS \u6216\u591A\u4E2A\u5730\u5740\uFF1A</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">&#39;koa&#39;</span>
<span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">&#39;http&#39;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;hello koa!&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\u670D\u52A1\u542F\u52A8\u4E86\uFF01&#39;</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\u670D\u52A1\u542F\u52A8\u4E86\uFF01&#39;</span><span class="token punctuation">,</span> <span class="token number">3001</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u521B\u5EFA\u5E76\u4F7F\u7528\u4E2D\u95F4\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u521B\u5EFA\u5E76\u4F7F\u7528\u4E2D\u95F4\u4EF6" aria-hidden="true">#</a> \u521B\u5EFA\u5E76\u4F7F\u7528\u4E2D\u95F4\u4EF6</h3><p>\u5B9E\u4F8B\u4E00\uFF1A\u5B9E\u73B0\u4E00\u4E2A\u8BA1\u7B97\u6574\u4E2A\u8BF7\u6C42\u5904\u7406\u6240\u82B1\u65F6\u95F4\u7684\u4E2D\u95F4\u4EF6</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">responseTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> ms <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;X-Response-Time&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5B9E\u4F8B\u4E8C\uFF1A\u5B9E\u73B0\u4E00\u4E2A\u8BF7\u6C42\u65E5\u5FD7\u4E2D\u95F4\u4EF6</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reponseLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> ms <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token comment">// \u8BB0\u5F55\u8BF7\u6C42\u548C\u54CD\u5E94\u65E5\u5FD7</span>
    ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">
      ======&gt;
      timestamp: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      request method: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      request url: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      request query: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      request body: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      &lt;======
      response body: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,
      response time: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms
    </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u901A\u8FC7\u4EE5\u4E0A\u4E8B\u4F8B\uFF0C\u53EF\u4EE5\u770B\u51FA\u9996\u5148\u8BF7\u6C42\u6D41\u901A\u8FC7 x-response-time \u548C logger \u4E2D\u95F4\u4EF6\u6765\u8BF7\u6C42\u4F55\u65F6\u5F00\u59CB\uFF0C\u7136\u540E\u7EE7\u7EED\u79FB\u4EA4\u63A7\u5236\u7ED9 response \u4E2D\u95F4\u4EF6\u3002\u5F53\u4E00\u4E2A\u4E2D\u95F4\u4EF6\u8C03\u7528 next() \u5219\u8BE5\u51FD\u6570\u6682\u505C\u5E76\u5C06\u63A7\u5236\u4F20\u9012\u7ED9\u5B9A\u4E49\u7684\u4E0B\u4E00\u4E2A\u4E2D\u95F4\u4EF6\u3002\u5F53\u5728\u4E0B\u6E38\u6CA1\u6709\u66F4\u591A\u7684\u4E2D\u95F4\u4EF6\u6267\u884C\u540E\uFF0C\u5806\u6808\u5C06\u5C55\u5F00\u5E76\u4E14\u6BCF\u4E2A\u4E2D\u95F4\u4EF6\u6062\u590D\u6267\u884C\u5176\u4E0A\u6E38\u884C\u4E3A\u3002</p><h2 id="\u5F00\u53D1\u57FA\u4E8Ekoa\u7684\u670D\u52A1\u5E94\u7528" tabindex="-1"><a class="header-anchor" href="#\u5F00\u53D1\u57FA\u4E8Ekoa\u7684\u670D\u52A1\u5E94\u7528" aria-hidden="true">#</a> \u5F00\u53D1\u57FA\u4E8Ekoa\u7684\u670D\u52A1\u5E94\u7528</h2><p>\u57FA\u4E8E\u4EE5\u4E0A\u7684\u4E86\u89E3\uFF0C\u5F00\u59CB\u5C01\u88C5\u57FA\u4E8Ekoa\u7684\u670D\u52A1\u8FD0\u7528\uFF0C\u9996\u5148\u6211\u4EEC\u5728server\u4E0B\u5EFA\u7ACB<code>application.ts</code>\uFF1A</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
  <span class="token comment">// koa\u5B9E\u4F8B</span>
  <span class="token keyword">public</span> app
  <span class="token comment">// config</span>
  <span class="token keyword">public</span> config
  <span class="token comment">// server</span>
  <span class="token keyword">public</span> server
  <span class="token comment">// logger</span>
  <span class="token keyword">public</span> logger
  <span class="token comment">// \u6784\u9020\u5668</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// \u6302\u8F7D\u5168\u5C40\u4E2D\u95F4\u4EF6</span>
  <span class="token function">useMiddlewares</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// \u6302\u8F7D\u8DEF\u7531</span>
  <span class="token function">mountRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// \u542F\u52A8\u670D\u52A1</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>application \u5927\u81F4\u4E0A\u7684\u7ED3\u6784\u662F\u8FD9\u6837\u7684\uFF0C\u6211\u4EEC\u53EA\u9700\u8981\u57FA\u4E8E\u8FD9\u4E2A\u7ED3\u6784\u53BB\u8865\u5145\u5B9E\u73B0\u5373\u53EF\u3002</p>`,18),P=s("\u5230\u8FD9\u91CC\uFF0C\u53D1\u73B0\u9996\u5148\u9700\u8981\u4E00\u4E2A\u65E5\u5FD7\u6A21\u5757\u6765\u65B9\u4FBF\u8C03\u8BD5\uFF0C\u4EE5\u53CA\u6253\u5370\u4E00\u4E9B\u5FC5\u8981\u7684\u4FE1\u606F\u8F93\u51FA\u5230\u63A7\u5236\u53F0\uFF0C\u4E3A\u4E86\u540E\u7EED\u670D\u52A1\u90E8\u7F72\u65F6\uFF0C\u4E5F\u80FD\u5F88\u597D\u7684\u7BA1\u7406\u65E5\u5FD7\uFF0C\u8FD9\u91CC\u6211\u4EEC\u9009\u7528\u6210\u719F\u7684\u65E5\u5FD7\u6846\u67B6 "),R={href:"https://github.com/log4js-node/log4js-node",target:"_blank",rel:"noopener noreferrer"},O=n("code",null,"log4js",-1),M=p(`<p>\u5B89\u88C5log4js</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">pnpm</span> i log4js
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5C01\u88C5\u4E00\u4E2A\u57FA\u7840\u7684logger\u7C7B\uFF1A</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>mport log4js<span class="token punctuation">,</span> <span class="token punctuation">{</span> Configuration<span class="token punctuation">,</span> Logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;log4js&#39;</span>
<span class="token keyword">const</span> _logger <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&#39;_logger&#39;</span><span class="token punctuation">)</span>

<span class="token doc-comment comment">/**
 * log4js\u57FA\u7840\u9002\u914D\u5668
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * logger \u6807\u8BB0
   */</span>
  <span class="token keyword">private</span> <span class="token punctuation">[</span>_logger<span class="token punctuation">]</span><span class="token operator">:</span> Logger <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token doc-comment comment">/**
   * \u6784\u9020\u5668
   * <span class="token keyword">@param</span> <span class="token parameter">config</span>
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token operator">:</span> Configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> logConfig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setLogger</span><span class="token punctuation">(</span>logConfig<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u94FE\u8DEF\u65E5\u5FD7
   * <span class="token keyword">@param</span> <span class="token parameter">message</span>
   * <span class="token keyword">@param</span> <span class="token parameter">args</span>
   * <span class="token keyword">@returns</span>
   */</span>
  <span class="token function">trace</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>_logger<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">[</span>_logger<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u8C03\u8BD5\u65E5\u5FD7
   * <span class="token keyword">@param</span> <span class="token parameter">message</span>
   * <span class="token keyword">@param</span> <span class="token parameter">args</span>
   * <span class="token keyword">@returns</span>
   */</span>
  <span class="token function">debug</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>_logger<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u4FE1\u606F\u65E5\u5FD7
   * <span class="token keyword">@param</span> <span class="token parameter">message</span>
   * <span class="token keyword">@param</span> <span class="token parameter">args</span>
   * <span class="token keyword">@returns</span>
   */</span>
  <span class="token function">info</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>_logger<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u8B66\u544A\u65E5\u5FD7
   * <span class="token keyword">@param</span> <span class="token parameter">message</span>
   * <span class="token keyword">@param</span> <span class="token parameter">args</span>
   * <span class="token keyword">@returns</span>
   */</span>
  <span class="token function">warn</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>_logger<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u9519\u8BEF\u65E5\u5FD7
   * <span class="token keyword">@param</span> <span class="token parameter">message</span>
   * <span class="token keyword">@param</span> <span class="token parameter">args</span>
   * <span class="token keyword">@returns</span>
   */</span>
  <span class="token function">error</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>_logger<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u81F4\u547D\u9519\u8BEF\u65E5\u5FD7
   * <span class="token keyword">@param</span> <span class="token parameter">message</span>
   * <span class="token keyword">@param</span> <span class="token parameter">args</span>
   * <span class="token keyword">@returns</span>
   */</span>
  <span class="token function">fatal</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>_logger<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">fatal</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token doc-comment comment">/**
   * log4js \u914D\u7F6E\u52A0\u8F7D
   */</span>
  <span class="token function">configure</span><span class="token punctuation">(</span>config<span class="token operator">:</span> Configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * log4js \u83B7\u53D6log4js\u7684\u5B9E\u4F8B
   */</span>
  <span class="token function">setLogger</span><span class="token punctuation">(</span>config<span class="token operator">:</span> Configuration<span class="token punctuation">,</span> category<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>_logger<span class="token punctuation">]</span> <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u683C\u5F0F\u5316\u914D\u7F6E
   * <span class="token keyword">@param</span> <span class="token parameter">config</span>
   * <span class="token keyword">@returns</span>
   */</span>
  <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token operator">:</span> Configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> config
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u518D\u57FA\u4E8E\u8FD9\u4E2A\u57FA\u7840\u7C7B\u5B9E\u73B0\u4E00\u4E2ADateFile\u7C7B\u578B\u7684logger\uFF1A</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> DateFileAppender <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;log4js&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Base <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Base&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LoggerConfig<span class="token punctuation">,</span> LoggerLevel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../types&quot;</span>

<span class="token doc-comment comment">/**
 * date file\u9002\u914D\u5668
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DateFileLogger</span> <span class="token keyword">extends</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token operator">:</span> LoggerConfig <span class="token operator">&amp;</span> DateFileAppender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> level<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> pattern<span class="token punctuation">,</span> alwaysIncludePattern<span class="token punctuation">,</span> absolute<span class="token punctuation">,</span> layout<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> numBackups <span class="token punctuation">}</span> <span class="token operator">=</span> config
    level <span class="token operator">=</span> <span class="token punctuation">(</span>level <span class="token operator">?</span> level<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&#39;ALL&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> LoggerLevel
    layout <span class="token operator">=</span> layout <span class="token operator">||</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;pattern&#39;</span><span class="token punctuation">,</span> pattern<span class="token operator">:</span> <span class="token string">&#39;%[[%d] [%z] [%p]%] - %m&#39;</span> <span class="token punctuation">}</span>

    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      appenders<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u63A7\u5236\u53F0\u8F93\u51FA</span>
        <span class="token builtin">console</span><span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">&#39;console&#39;</span><span class="token punctuation">,</span> layout<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// \u8F93\u51FA\u5230\u6587\u4EF6</span>
        dateFile<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">&#39;dateFile&#39;</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> pattern<span class="token punctuation">,</span> alwaysIncludePattern<span class="token punctuation">,</span> absolute<span class="token punctuation">,</span> layout<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> numBackups<span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      categories<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span> appenders<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;dateFile&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;console&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> level <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728server\u6587\u4EF6\u5939\u4E0B\u521B\u5EFA\u4E00\u4E2Alogger.ts\uFF0C\u4E3B\u8981\u4F5C\u7528\u662F\u8BA9\u6211\u4EEC\u7684logger\u5B9E\u4F8B\u5355\u4F8B\u5316\uFF1A</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ILoggerConfig<span class="token punctuation">,</span> loggerConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/config&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DateFileLogger<span class="token punctuation">,</span> Logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/utils&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ApplicationLogger</span> <span class="token operator">=</span> Logger<span class="token operator">&lt;</span>DateFileLogger<span class="token operator">&gt;</span>

<span class="token doc-comment comment">/**
 * \u5168\u5C40\u4FDD\u5B58\u5B9E\u4F8B\uFF0C\u907F\u514D\u91CD\u590D\u5B9E\u4F8B\u5316
 */</span>
<span class="token keyword">let</span> globalLogger<span class="token operator">:</span> ApplicationLogger <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> createLogger <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token operator">:</span> ILoggerConfig<span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&#39;app&#39;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>globalLogger<span class="token punctuation">)</span> <span class="token keyword">return</span> globalLogger
  <span class="token keyword">const</span> handler <span class="token operator">=</span> config<span class="token punctuation">.</span>handler
  <span class="token keyword">delete</span> config<span class="token punctuation">.</span>handler

  globalLogger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Logger<span class="token operator">&lt;</span>DateFileLogger<span class="token operator">&gt;</span></span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
  <span class="token keyword">return</span> globalLogger
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">createLogger</span><span class="token punctuation">(</span>loggerConfig<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>logger\u914D\u7F6E\u6587\u4EF6\uFF1A</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token doc-comment comment">/**
 * \u65E5\u5FD7\u914D\u7F6E
 */</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_ROOT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/constants&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DateFileLogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/utils/logger&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DateFileAppender <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;log4js&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&#39;path&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ILoggerConfig</span> <span class="token operator">=</span> Partial<span class="token operator">&lt;</span>DateFileAppender<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>
  handler<span class="token operator">:</span> <span class="token builtin">any</span>
  status<span class="token operator">:</span> <span class="token string">&#39;close&#39;</span> <span class="token operator">|</span> <span class="token string">&#39;open&#39;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * \u65E5\u5FD7\u914D\u7F6E
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> loggerConfig<span class="token operator">:</span> ILoggerConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  handler<span class="token operator">:</span> DateFileLogger<span class="token punctuation">,</span>
  filename<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">APP_ROOT</span><span class="token punctuation">,</span> <span class="token string">&#39;logs/logs.log&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  pattern<span class="token operator">:</span> <span class="token string">&#39;-yyyy-MM-dd&#39;</span><span class="token punctuation">,</span>
  alwaysIncludePattern<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  status<span class="token operator">:</span> <span class="token string">&#39;open&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7EE7\u7EED\u5B8C\u5584application.ts\uFF0C\u628A\u5185\u5BB9\u90FD\u8865\u5145\u8D77\u6765</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">&#39;koa&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createServer<span class="token punctuation">,</span> Server <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;http&#39;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> LoggerNameSpace<span class="token punctuation">,</span> <span class="token constant">NOT_FOUND_APPLICATION_CONFIG</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/constants&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApplicationLogger<span class="token punctuation">,</span> createLogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./logger&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useMiddlewares <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./core/middlewares/useMiddlewares&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> loggerConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/config&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> initRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./router&#39;</span>

<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> AppContext<span class="token punctuation">,</span> Config <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/types&#39;</span>

<span class="token doc-comment comment">/**
 * \u5E94\u7528
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * koa\u5B9E\u4F8B
   */</span>
  <span class="token keyword">public</span> app<span class="token operator">:</span> Koa

  <span class="token doc-comment comment">/**
   * \u670D\u52A1\u914D\u7F6E
   */</span>
  <span class="token keyword">public</span> config<span class="token operator">:</span> Config<span class="token punctuation">.</span>Application

  <span class="token doc-comment comment">/**
   * \u670D\u52A1\u5B9E\u4F8B
   */</span>
  <span class="token keyword">public</span> server<span class="token operator">:</span> Server

  <span class="token doc-comment comment">/**
   * \u65E5\u5FD7\u5B9E\u4F8B
   */</span>
  <span class="token keyword">public</span> logger<span class="token operator">:</span> ApplicationLogger

  <span class="token doc-comment comment">/**
   * \u6784\u9020\u51FD\u6570
   * <span class="token keyword">@param</span> <span class="token parameter">config</span>
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token operator">:</span> Config<span class="token punctuation">.</span>Application<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">TypeError</span><span class="token punctuation">(</span><span class="token constant">NOT_FOUND_APPLICATION_CONFIG</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config
    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token function">createLogger</span><span class="token punctuation">(</span>loggerConfig<span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mountRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u6302\u8F7D\u4E2D\u95F4\u4EF6
   */</span>
  <span class="token function">useMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u505A\u4E00\u4E9B\u5BF9\u8C61\u7684\u6302\u8F7D\u65B9\u4FBF\u540E\u7EED\u4F7F\u7528</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token operator">:</span> AppContext<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>$ <span class="token operator">=</span> ctx<span class="token punctuation">.</span>server <span class="token operator">=</span> <span class="token keyword">this</span>
      ctx<span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logger
      <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// \u6302\u8F7D\u4E2D\u95F4\u4EF6</span>
    <span class="token function">useMiddlewares</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u542F\u52A8\u670D\u52A1
   */</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> host<span class="token punctuation">,</span> port <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LoggerNameSpace<span class="token punctuation">.</span>App<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\u670D\u52A1\u5DF2\u8FD0\u884C\u5728http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token string">&#39;\u2714 &#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">fatal</span><span class="token punctuation">(</span>LoggerNameSpace<span class="token punctuation">.</span>App<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\u670D\u52A1http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\u542F\u52A8\u5931\u8D25!</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>useMiddlewares.ts\uFF0C\u4E3B\u8981\u4F5C\u7528\u662F\u628A\u4E2D\u95F4\u4EF6\u7EDF\u4E00\u5230\u4E00\u4E2A\u5730\u65B9\u7BA1\u7406\uFF0C\u65B9\u4FBF\u6392\u67E5\u548C\u7EDF\u4E00\u914D\u7F6E\uFF1A</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">&#39;koa&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> koaBody <span class="token keyword">from</span> <span class="token string">&#39;koa-body&#39;</span>
<span class="token keyword">import</span> koaCors <span class="token keyword">from</span> <span class="token string">&#39;@koa/cors&#39;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> requestError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./requestError&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> requestLog <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./requestLogger&#39;</span>

<span class="token doc-comment comment">/**
 * middleware
 * <span class="token keyword">@param</span> <span class="token parameter">app</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useMiddlewares</span> <span class="token operator">=</span> <span class="token punctuation">(</span>app<span class="token operator">:</span> Koa<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaCors</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      allowHeaders<span class="token operator">:</span> <span class="token string">&#39;Content-Type, Content-Length, Authorization, Accept, X-Requested-With&#39;</span><span class="token punctuation">,</span>
      allowMethods<span class="token operator">:</span> <span class="token string">&#39;PUT, POST, GET, DELETE, OPTIONS&#39;</span><span class="token punctuation">,</span>
      origin<span class="token operator">:</span> <span class="token string">&#39;*&#39;</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">requestLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">requestError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>corsAllow \u53EA\u505A\u4E86\u4E00\u4EF6\u4E8B\u5C31\u662F\u628A options\u7684\u8BF7\u6C42\u76F4\u63A5\u54CD\u5E94 200 requestError \u628A\u9519\u8BEF\u66F4\u53CB\u597D\u7684\u54CD\u5E94\u7ED9\u9875\u9762\u6216\u8005\u63A5\u53E3 requestLogger \u8BF7\u6C42\u65E5\u5FD7</p><h2 id="cors\u539F\u7406\u53CA-koa-cors" tabindex="-1"><a class="header-anchor" href="#cors\u539F\u7406\u53CA-koa-cors" aria-hidden="true">#</a> CORS\u539F\u7406\u53CA@koa/cors</h2><h3 id="_1\u3001\u4E3A\u4EC0\u4E48\u4F1A\u6709\u8DE8\u57DF\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u4E3A\u4EC0\u4E48\u4F1A\u6709\u8DE8\u57DF\u95EE\u9898" aria-hidden="true">#</a> 1\u3001\u4E3A\u4EC0\u4E48\u4F1A\u6709\u8DE8\u57DF\u95EE\u9898\uFF1F</h3><p>\u8FD9\u662F\u6D4F\u89C8\u5668\u7684\u540C\u6E90\u7B56\u7565\u6240\u9020\u6210\u7684\uFF0C\u540C\u6E90\u7B56\u7565\u9650\u5236\u4E86\u4ECE\u540C\u4E00\u4E2A\u6E90\u52A0\u8F7D\u7684\u6587\u6863\u6216\u811A\u672C\u5982\u4F55\u4E0E\u6765\u81EA\u53E6\u4E00\u4E2A\u6E90\u7684\u8D44\u6E90\u8FDB\u884C\u4EA4\u4E92\u3002\u8FD9\u662F\u4E00\u4E2A\u7528\u4E8E\u9694\u79BB\u6F5C\u5728\u6076\u610F\u6587\u4EF6\u7684\u91CD\u8981\u5B89\u5168\u673A\u5236\u3002</p><h3 id="_2\u3001\u5982\u4F55\u89E3\u51B3\u8DE8\u57DF" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u5982\u4F55\u89E3\u51B3\u8DE8\u57DF" aria-hidden="true">#</a> 2\u3001\u5982\u4F55\u89E3\u51B3\u8DE8\u57DF?</h3><ul><li>jsonp: \u5E26\u6709src\u5C5E\u6027\u7684\u6807\u7B7E\u90FD\u53EF\u4EE5\u7528\u6765\uFF0C \u4F46\u662F\u53EA\u80FD\u5904\u7406GET\u8BF7\u6C42</li><li>document.domain + iframe\u8DE8\u57DF</li><li>location.hash + iframe</li><li>window.name + iframe</li><li>postMessage\u8DE8\u57DF</li><li>Nginx\u914D\u7F6E\u53CD\u5411\u4EE3\u7406</li><li>CORS(\u8DE8\u57DF\u8D44\u6E90\u5171\u4EAB)\uFF1A\u652F\u6301\u6240\u6709\u7C7B\u578B\u7684HTTP\u8BF7\u6C42</li></ul><p>\u76F8\u4FE1\u5927\u5BB6\u5BF9\u4E8E\u4EE5\u4E0A\u7684\u89E3\u51B3\u65B9\u6CD5\u90FD\u5F88\u719F\u6089\uFF0C\u8FD9\u91CC\u4E0D\u518D\u5BF9\u6BCF\u4E00\u79CD\u65B9\u6CD5\u5C55\u5F00\u8BB2\u89E3\uFF0C\u63A5\u4E0B\u6765\u4E3B\u8981\u8BB2\u4E00\u4E0BCORS\uFF1B</p><h3 id="_3\u3001cors\u8BF7\u6C42\u76F8\u5173\u7684\u5B57\u6BB5-\u90FD\u4EE5-access-control-\u5F00\u5934" tabindex="-1"><a class="header-anchor" href="#_3\u3001cors\u8BF7\u6C42\u76F8\u5173\u7684\u5B57\u6BB5-\u90FD\u4EE5-access-control-\u5F00\u5934" aria-hidden="true">#</a> 3\u3001CORS\u8BF7\u6C42\u76F8\u5173\u7684\u5B57\u6BB5\uFF0C\u90FD\u4EE5 Access-Control-\u5F00\u5934</h3><ul><li>Access-Control-Allow-Origin\uFF1A\u5FC5\u9009 <ul><li>\u8BF7\u6C42\u5934Origin\u5B57\u6BB5\u7684\u503C</li><li>*\uFF1A\u63A5\u53D7\u4EFB\u4F55\u57DF\u540D</li></ul></li><li>Access-Control-Allow-Credentials\uFF1A\u53EF\u9009\uFF0C <ul><li>true: \u8868\u793A\u5141\u8BB8\u53D1\u9001cookie\uFF0C\u6B64\u65F6Access-Control-Allow-Origin\u4E0D\u80FD\u8BBE\u7F6E\u4E3A*\uFF0C\u5FC5\u987B\u6307\u5B9A\u660E\u786E\u7684\uFF0C\u4E0E\u8BF7\u6C42\u7F51\u9875\u4E00\u81F4\u7684\u57DF\u540D\u3002</li><li>\u4E0D\u8BBE\u7F6E\u8BE5\u5B57\u6BB5\uFF1A\u4E0D\u9700\u8981\u6D4F\u89C8\u5668\u53D1\u9001cookie</li></ul></li><li>Access-Control-Expose-Headers\uFF1A\u53EF\u9009 <ul><li>Cache-Control</li><li>Content-Language</li><li>Content-Type</li><li>Expires</li><li>Last-Modified</li><li>Pragma \u54CD\u5E94\u62A5\u5934\u6307\u793A\u54EA\u4E9B\u62A5\u5934\u53EF\u4EE5\u516C\u5F00\u4E3A\u901A\u8FC7\u5217\u51FA\u4ED6\u4EEC\u7684\u540D\u5B57\u7684\u54CD\u5E94\u7684\u4E00\u90E8\u5206\u3002\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0C\u53EA\u663E\u793A6\u4E2A\u7B80\u5355\u7684\u54CD\u5E94\u6807\u5934\uFF1A\u5982\u679C\u60F3\u8981\u8BA9\u5BA2\u6237\u7AEF\u53EF\u4EE5\u8BBF\u95EE\u5230\u5176\u4ED6\u7684\u9996\u90E8\u4FE1\u606F\uFF0C\u53EF\u4EE5\u5C06\u5B83\u4EEC\u5728 Access-Control-Expose-Headers \u91CC\u9762\u5217\u51FA\u6765\u3002</li></ul></li></ul><h3 id="_4\u3001withcredentials-\u5C5E\u6027" tabindex="-1"><a class="header-anchor" href="#_4\u3001withcredentials-\u5C5E\u6027" aria-hidden="true">#</a> 4\u3001withCredentials \u5C5E\u6027</h3><p>CORS\u8BF7\u6C42\u9ED8\u8BA4\u4E0D\u53D1\u9001Cookie\u548CHTTP\u8BA4\u8BC1\u4FE1\u606F\uFF0C\u5982\u679C\u8981\u628ACookie\u53D1\u5230\u670D\u52A1\u5668\uFF0C\u4E00\u65B9\u9762\u9700\u8981\u670D\u52A1\u5668\u540C\u610F\uFF0C\u8BBE\u7F6E\u54CD\u5E94\u5934Access-Control-Allow-Credentials: true,\u53E6\u4E00\u65B9\u9762\u5728\u5BA2\u6237\u7AEF\u53D1\u51FA\u8BF7\u6C42\u7684\u65F6\u5019\u4E5F\u8981\u8FDB\u884C\u4E00\u4E9B\u8BBE\u7F6E;</p><h3 id="_5\u3001\u9884\u68C0\u8BF7\u6C42" tabindex="-1"><a class="header-anchor" href="#_5\u3001\u9884\u68C0\u8BF7\u6C42" aria-hidden="true">#</a> 5\u3001\u9884\u68C0\u8BF7\u6C42</h3><p>\u9884\u68C0\u8BF7\u6C42\u7528\u7684\u8BF7\u6C42\u65B9\u6CD5\u662FOPTIONS\uFF0C\u8868\u793A\u8FD9\u4E2A\u8BF7\u6C42\u662F\u7528\u6765\u8BE2\u95EE\u7684\u3002\u5934\u4FE1\u606F\u91CC\u9762\uFF0C\u5173\u952E\u5B57\u6BB5\u662FOrigin\uFF0C\u8868\u793A\u8BF7\u6C42\u6765\u81EA\u54EA\u4E2A\u57DF\u3002\u9664\u4E86Origin\uFF0C\u9884\u68C0\u8BF7\u6C42\u7684\u5934\u4FE1\u606F\u5305\u62EC\u4E24\u4E2A\u7279\u6B8A\u5B57\u6BB5\uFF1A</p><ul><li>Access-Control-Request-Method\uFF1A\u5FC5\u9009\uFF0C\u7528\u6765\u5217\u51FA\u6D4F\u89C8\u5668\u7684CORS\u8BF7\u6C42\u4F1A\u7528\u5230\u54EA\u4E9BHTTP\u65B9\u6CD5\uFF0C\u4E0A\u4F8B\u662FPOST</li><li>Access-Control-Request-Headers\uFF1A\u8BE5\u5B57\u6BB5\u662F\u4E00\u4E2A\u7528\u9017\u53F7\u5206\u5272\u7684\u5B57\u7B26\u4E32\uFF0C\u6267\u884C\u6D4F\u89C8\u5668CORS\u8BF7\u6C42\u4F1A\u989D\u5916\u53D1\u9001\u7684\u5934\u4FE1\u606F\u5B57\u6BB5\uFF0C\u4E0A\u4F8B\u662FContent-Type;</li></ul><p>\u670D\u52A1\u5668\u6536\u5230\u9884\u68C0\u8BF7\u6C42\u4EE5\u540E\uFF0C\u68C0\u67E5\u4E86Origin\u3001Access-Control-Request-Method\u548CAccess-Control-Request-Headers\u5B57\u6BB5\u4EE5\u540E\uFF0C\u786E\u8BA4\u5141\u8BB8\u8DE8\u57DF\u8BF7\u6C42\uFF0C\u5C31\u53EF\u4EE5\u505A\u51FA\u56DE\u5E94\u3002\u4E0A\u9762\u7684HTTP\u56DE\u5E94\u4E2D\uFF0C\u5173\u952E\u7684\u662FAccess-Control-Allow-Origin\u5B57\u6BB5\uFF0C\u8868\u793Ahttp://127.0.0.1:3000\u53EF\u4EE5\u8BF7\u6C42\u6570\u636E\u3002\u8BE5\u5B57\u6BB5\u4E5F\u53EF\u4EE5\u8BBE\u4E3A\u661F\u53F7\uFF0C\u8868\u793A\u540C\u610F\u4EFB\u610F\u8DE8\u6E90\u8BF7\u6C42\u3002</p><p>\u5982\u679C\u6D4F\u89C8\u5668\u5426\u5B9A\u4E86\u201C\u9884\u68C0\u201D\u8BF7\u6C42\uFF0C\u5C31\u4F1A\u8FD4\u56DE\u4E00\u4E2A\u6B63\u5E38\u7684HTTP\u56DE\u5E94\uFF0C\u4F46\u662F\u6CA1\u6709\u4EFB\u4F55CORS\u76F8\u5173\u7684\u5934\u4FE1\u606F\u5B57\u6BB5\uFF0C\u8FD9\u65F6\uFF0C\u6D4F\u89C8\u5668\u5C31\u4F1A\u8BA4\u5B9A\uFF0C\u670D\u52A1\u5668\u4E0D\u540C\u610F\u9884\u68C0\u8BF7\u6C42\uFF0C\u56E0\u6B64\u89E6\u53D1\u4E00\u4E2A\u9519\u8BEF\uFF0C\u88ABXMLHttpRequest\u5BF9\u8C61\u7684onerror\u56DE\u8C03\u51FD\u6570\u6355\u83B7h\u3002</p><p>\u670D\u52A1\u5668\u56DE\u5E94\u7684\u5176\u4ED6CORS\u5B57\u6BB5</p><ul><li>Access-Control-Allow-Methods\uFF1A\u5FC5\u9700\uFF1B\u5B83\u7684\u503C\u662F\u9017\u53F7\u5206\u9694\u7684\u4E00\u4E2A\u5B57\u7B26\u4E32\uFF0C\u8868\u660E\u670D\u52A1\u5668\u652F\u6301\u7684\u6240\u6709\u8DE8\u57DF\u8BF7\u6C42\u7684\u65B9\u6CD5\u3002\u6CE8\u610F\uFF0C\u8FD4\u56DE\u7684\u662F\u6240\u6709\u652F\u6301\u7684\u65B9\u6CD5\uFF0C\u800C\u4E0D\u5355\u662F\u6D4F\u89C8\u5668\u8BF7\u6C42\u7684\u65B9\u6CD5\u3002\u8FD9\u662F\u4E3A\u4E86\u907F\u514D\u591A\u6B21\u9884\u68C0\u8BF7\u6C42\u3002</li><li>Access-Control-Allow-Headers\uFF1A\u5982\u679C\u6D4F\u89C8\u5668\u8BF7\u6C42\u5934\u91CC\u5305\u62ECAccess-Control-Request-Headers\u5B57\u6BB5\uFF0C\u5219Access-Control-Allow-Headers\u5B57\u6BB5\u662F\u5FC5\u9700\u7684\u3002\u5B83\u4E5F\u662F\u4E00\u4E2A\u9017\u53F7\u5206\u9694\u7684\u5B57\u7B26\u4E32\uFF0C\u8868\u660E\u670D\u52A1\u5668\u652F\u6301\u7684\u6240\u6709\u5934\u4FE1\u606F\u5B57\u6BB5\uFF0C\u4E0D\u9650\u4E8E\u6D4F\u89C8\u5668\u5728\u9884\u68C0\u4E2D\u8BF7\u6C42\u7684\u5B57\u6BB5\u3002</li><li>Access-Control-Allow-Credentials\uFF1A\u4E0E\u7B80\u5355\u8BF7\u6C42\u65F6\u542B\u4E49\u76F8\u540C\u3002</li><li>Access-Control-Allow-Max-Age: \u53EF\u9009\uFF0C\u7528\u6765\u6307\u5B9A\u672C\u6B21\u9884\u68C0\u8BF7\u6C42\u7684\u6709\u6548\u671F\u3002\u5355\u4F4D\u4E3A\u79D2\u3002\u5728\u6709\u6548\u671F\u5185\uFF0C\u4E0D\u7528\u53D1\u51FA\u53E6\u4E00\u6761\u9884\u68C0\u8BF7\u6C42</li></ul><h2 id="\u5F15\u5165koa-router" tabindex="-1"><a class="header-anchor" href="#\u5F15\u5165koa-router" aria-hidden="true">#</a> \u5F15\u5165koa-router</h2><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">&#39;koa-router&#39;</span>
<span class="token keyword">import</span> commonMiddleware <span class="token keyword">from</span> <span class="token string">&#39;../middlewares/common&#39;</span>
<span class="token keyword">import</span> validateParams <span class="token keyword">from</span> <span class="token string">&#39;../middlewares/validateParams&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> testSchema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../validator/test&#39;</span>
<span class="token keyword">import</span> TestController <span class="token keyword">from</span> <span class="token string">&#39;../controller/test.ts&#39;</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  prefix<span class="token operator">:</span> <span class="token string">&#39;/standard-test&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">&#39;/name&#39;</span><span class="token punctuation">,</span>
  commonMiddleware<span class="token punctuation">,</span>
  <span class="token function">validateParams</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span> testSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
  TestController<span class="token punctuation">.</span>getName
<span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&#39;/name&#39;</span><span class="token punctuation">,</span>
  commonMiddleware<span class="token punctuation">,</span>
  <span class="token function">validateParams</span><span class="token punctuation">(</span><span class="token string">&#39;post&#39;</span><span class="token punctuation">,</span> testSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
  TestController<span class="token punctuation">.</span>updateName
<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u5199\u4E86\u4E00\u4E2A\u5F88\u7B80\u5355\u7684test.ts\u7684\u8DEF\u7531\u6A21\u5757\uFF0C\u53EF\u80FD\u4F60\u4F1A\u89C9\u5F97\u5F88\u6E05\u6670\u963F\uFF0C\u60F3\u8981\u4EC0\u4E48\u529F\u80FD\u90FD\u80FD\u5B9E\u73B0\uFF0C\u8FD9\u662F\u80AF\u5B9A\u7684\uFF0C\u8FD9\u53EF\u662F\u5B98\u65B9\u7684\u5199\u6CD5\uFF0C\u4F46\u662F\u5B9E\u73B0\u548C\u5F00\u53D1\u6210\u672C\u53C8\u662F\u53E6\u5916\u4E00\u56DE\u4E8B\uFF0C\u7279\u522B\u662F\u5F53\u4E1A\u52A1\u590D\u6742\u8D77\u6765\u540E\uFF0C\u5728\u771F\u6B63\u7684\u4E1A\u52A1\u4E0A\uFF0C\u4E00\u4E2A\u6A21\u5757\u4E0D\u53EF\u80FD\u53EA\u6709\u4E24\u4E2A\u7B80\u5355\u7684\u63A5\u53E3\uFF0C\u6839\u636E\u4E0A\u9762\u7684test.ts\u53EF\u4EE5\u5206\u6790\u4F20\u7EDF\u5199\u6CD5\u7684\u77ED\u677F\uFF0C\u91CD\u70B9\u662F\u6211\u5F15\u5165\u7684\u4E24\u4E2A\u4E2D\u95F4\u4EF6\u4E0A\uFF1A</p><ul><li>1\u3001\u591A\u4E2A\u6A21\u5757\u9700\u8981\u521B\u5EFA\u591A\u4E2A\u8DEF\u7531\u5B9E\u4F8B</li><li>2\u3001\u65E0\u6CD5\u5BF9\u9879\u76EE\u7684\u5168\u90E8\u8DEF\u7531\u7EDF\u4E00\u6DFB\u52A0\u524D\u7F00</li><li>3\u3001\u591A\u4E2A\u4E2D\u95F4\u4EF6\u4E4B\u95F4\u65E0\u6CD5\u8FDB\u884C\u6570\u636E\u4F20\u9012\uFF0C\u65E0\u6CD5\u611F\u77E5\u5176\u4ED6\u4E2D\u95F4\u4EF6\u7684\u4F7F\u7528\uFF0C\u5B8C\u5168\u9694\u79BB</li><li>4\u3001\u65E0\u6CD5\u5BF9\u4E00\u4E2A\u6A21\u5757\u7684\u63A5\u53E3\u7EDF\u4E00\u6DFB\u52A0\u4E2D\u95F4\u4EF6</li></ul><p>1\u30012\u70B9\u975E\u5E38\u660E\u663E\uFF1B\u7B2C3\u70B9\u5BF9\u5E94\u7684\u662F\u4E0A\u9762\u7684 validateParams \u4E2D\u95F4\u4EF6\uFF0C\u9700\u8981\u4F20\u5165\u8BF7\u6C42\u65B9\u6CD5\u548Cjoi\u6821\u9A8C\u89C4\u5219\uFF0C\u56E0\u4E3A\u4E0D\u540C\u7684\u8BF7\u6C42\u65B9\u6CD5\uFF0Ckoa\u5728\u62FF\u53C2\u6570\u7684\u65B9\u5F0F\u4E0D\u540C\uFF0C\u8FD9\u91CC\u5C31\u4F53\u73B0\u4E86\u5728\u4F7F\u7528 validateParams \u4E2D\u95F4\u4EF6\u65F6\uFF0C\u65E0\u6CD5\u611F\u77E5\u5F53\u524D\u63A5\u53E3\u662F\u4EC0\u4E48\u8BF7\u6C42\u65B9\u6CD5\uFF0C\u9700\u8981\u624B\u52A8\u4F20\u5165\uFF1B\u7B2C4\u70B9\u5BF9\u5E94\u7684\u662F\u4E0A\u9762\u7684 commonMiddleware\uFF0C\u5F53\u6BCF\u4E2A\u63A5\u53E3\u90FD\u9700\u8981\u4F7F\u7528\u5230\u65F6\uFF0C\u4F20\u7EDF\u5199\u6CD5\u53EA\u80FD\u4E00\u4E2A\u4E2A\u63A5\u53E3\u8FDB\u884C\u6DFB\u52A0\uFF0C\u65E0\u6CD5\u5BF9\u6574\u4E2A\u6A21\u5757\u8FDB\u884C\u4F7F\u7528\u3002</p><p>\u5B9E\u73B0\u4E00\u4E2A\u7B80\u5355\u7684\u3001\u4E0D\u600E\u4E48\u7075\u6D3B\u7684\u8DEF\u7531\u81EA\u52A8\u6CE8\u5165\uFF0C\u9996\u5148\u5728controller\u4E0B\u65B0\u5EFA\u4E00\u4E2ABaseController\u7684\u62BD\u8C61\u7C7B</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token doc-comment comment">/**
 * \u5C01\u88C5\u4E00\u4E2A\u62BD\u8C61\u7684\u6838\u5FC3controller
 */</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Response <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/server&quot;</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u6838\u5FC3\u62BD\u8C61\u7C7B
 */</span>
<span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>

  <span class="token doc-comment comment">/**
   * \u8BF7\u6C42\u65B9\u6CD5\u679A\u4E3E
   */</span>
  <span class="token keyword">public</span> <span class="token constant">METHODS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">GET</span><span class="token operator">:</span> <span class="token string">&#39;GET&#39;</span><span class="token punctuation">,</span>
    <span class="token constant">POST</span><span class="token operator">:</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">,</span>
    <span class="token constant">PUT</span><span class="token operator">:</span> <span class="token string">&#39;PUT&#39;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u6307\u5B9A\u5F53\u524Dapi\u7684\u8BF7\u6C42\u65B9\u5F0F
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">abstract</span> method<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token doc-comment comment">/**
   * \u6307\u5B9A\u5F53\u524Dapi\u5FC5\u987B\u5B8C\u6210\u65B9\u6CD5
   * <span class="token keyword">@param</span> <span class="token parameter">params</span>
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token function">handler</span><span class="token punctuation">(</span>params<span class="token operator">?</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Response
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u65B0\u5EFAcontroller/test/list.api.ts:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Response <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/server&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../BaseController&quot;</span>

<span class="token keyword">interface</span> <span class="token class-name">IParams</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * \u6D4B\u8BD5api\uFF0C\u8BF7\u6C42\u5730\u5740\uFF1Arouter.prefix + /test/list
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span><span class="token punctuation">{</span>

  <span class="token keyword">public</span> method <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">METHODS</span><span class="token punctuation">.</span><span class="token constant">GET</span>

  <span class="token keyword">public</span> <span class="token generic-function"><span class="token function">handler</span><span class="token generic class-name"><span class="token operator">&lt;</span>IParams<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>params<span class="token operator">:</span> IParams<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Response<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token string">&#39;\u6210\u529F&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7528\u8FD9\u4E2A\u4E0D\u600E\u4E48\u7075\u6D3B\u7684controller\u4F5C\u4E3A\u8DEF\u7531\u81EA\u52A8\u6CE8\u5165\u7684\u4F8B\u5B50\uFF0C\u53EF\u4EE5\u5F88\u597D\u7684\u7406\u89E3\u6574\u4E2A\u6D41\u7A0B\uFF1A</p><p>server/router/router.ts:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> application <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/config&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">&#39;koa-router&#39;</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  prefix<span class="token operator">:</span> application<span class="token punctuation">.</span>routerPrefix <span class="token operator">||</span> <span class="token string">&#39;/&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F00\u59CB\u5B9E\u73B0\u8DEF\u7531\u81EA\u52A8\u6CE8\u5165\uFF0C\u6211\u4EEC\u5B9E\u73B0\u6CE8\u5165\u7684\u903B\u8F91\u662F\uFF1A\u6BD4\u5982 controller/test/list.api.ts \u90A3\u6211\u4EEC\u6CE8\u5165\u7684\u8DEF\u5F84\u662F\uFF1Arouter.prefix + /test/list</p><p><code>server/router/initRouter.ts</code> \u8BB0\u8F7D\u7684\u903B\u8F91\u662F\u8FD9\u6837\u7684\uFF0C\u9996\u5148\u9012\u5F52\u62FF\u5230controller\u6587\u4EF6\u5939\u4E0B\u7684\u6240\u6709 .api.ts \u7684\u6587\u4EF6\uFF0C\u7136\u540E\u5BFC\u5165\u6587\u4EF6\uFF0C\u5E76\u5B9E\u4F8B\u5316\u5B83\uFF0C\u83B7\u5F97\u5BF9\u5E94\u7684 <code>method</code> \u548C <code>handler</code>, \u7136\u540E\u52A8\u6001\u6CE8\u5165\u5230<code>koa-router</code>\u4E2D\uFF0C\u6700\u540E\u628Arouter\u6302\u8F7D\u5230koa\u4E2D\u3002</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Application <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../application&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">&#39;./router&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> readdirRecursive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/utils/file&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/types/application&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Next <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Response <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../response&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">CONTROLLER_ROOT</span><span class="token punctuation">,</span> LoggerNameSpace <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/constants&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">IRouterMate</span> <span class="token punctuation">{</span>
  routePath<span class="token operator">:</span> <span class="token builtin">string</span>
  pathApi<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * \u521D\u59CB\u5316\u8DEF\u7531\u6302\u8F7D
 * <span class="token keyword">@param</span> <span class="token parameter">app</span>
 * <span class="token keyword">@returns</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initRouter</span><span class="token punctuation">(</span>app<span class="token operator">:</span> Application<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> methodsRouter <span class="token operator">=</span> <span class="token punctuation">(</span>router <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token doc-comment comment">/**
   * \u6536\u96C6controller
   * <span class="token keyword">@param</span> <span class="token parameter">controllerPath</span>
   */</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">importControllerFiles</span><span class="token punctuation">(</span>controllerPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> controllerFiles <span class="token operator">=</span> <span class="token function">readdirRecursive</span><span class="token punctuation">(</span>controllerPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> filePath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;.api.ts&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> routerMeta<span class="token operator">:</span> IRouterMate<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    controllerFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>fileApi <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> infoApi <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fileApi<span class="token punctuation">)</span>
      <span class="token keyword">const</span> pathApi <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>controllerPath<span class="token punctuation">,</span> fileApi<span class="token punctuation">)</span>
      <span class="token keyword">const</span> routePath <span class="token operator">=</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token operator">...</span>infoApi<span class="token punctuation">.</span>dir<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>infoApi<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token string">&#39;.api.ts&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      routerMeta<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        routePath<span class="token punctuation">,</span>
        pathApi
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> routerMeta<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> item <span class="token operator">=</span> routerMeta<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">await</span> <span class="token function">controllerMounter</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>routePath<span class="token punctuation">,</span> item<span class="token punctuation">.</span>pathApi<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u8FC7\u6EE4\u6389\u8DEF\u7531\u4E0D\u5141\u8BB8\u7684\u8DEF\u7531\u65B9\u6CD5
   * <span class="token keyword">@param</span> <span class="token parameter">methods</span>
   */</span>
  <span class="token keyword">function</span> <span class="token function">filterRouteMethod</span><span class="token punctuation">(</span>methods<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> methods<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>method <span class="token operator">=&gt;</span> method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>method <span class="token operator">=&gt;</span> methodsRouter<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u6302\u8F7Dcontroller
   * <span class="token keyword">@param</span> <span class="token parameter">routePath</span>
   * <span class="token keyword">@param</span> <span class="token parameter">controllerPath</span>
   */</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">controllerMounter</span><span class="token punctuation">(</span>routePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> controllerPath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span>controllerPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
    <span class="token keyword">const</span> controllerInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> instanceMethod <span class="token operator">=</span> controllerInstance<span class="token punctuation">.</span>method
    <span class="token comment">// \u83B7\u53D6\u5F53\u524Dapi\u8BF7\u6C42\u7684\u65B9\u6CD5</span>
    <span class="token keyword">const</span> methods <span class="token operator">=</span> instanceMethod <span class="token operator">?</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>instanceMethod<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">filterRouteMethod</span><span class="token punctuation">(</span>instanceMethod<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">filterRouteMethod</span><span class="token punctuation">(</span><span class="token punctuation">[</span>instanceMethod<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> method <span class="token keyword">of</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mountControllerWithRouter</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> controllerInstance<span class="token punctuation">,</span> routePath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * \u628Acontroller\u548C\u8DEF\u7531\u6302\u8D77\u6765
   * <span class="token keyword">@param</span> <span class="token parameter">method</span>
   * <span class="token keyword">@param</span> <span class="token parameter">controller</span>
   * <span class="token keyword">@param</span> <span class="token parameter">routePath</span>
   */</span>
  <span class="token keyword">function</span> <span class="token function">mountControllerWithRouter</span><span class="token punctuation">(</span>method<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> controller<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> routePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u8FD9\u91CC\u53EF\u4EE5\u52A0\u8F7D\u4E00\u4E9B\u524D\u7F6E\u7684\u4E2D\u95F4\u4EF6</span>

    <span class="token comment">// \u52A0\u8F7D\u8DEF\u7531</span>
    <span class="token punctuation">;</span><span class="token punctuation">(</span>router <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span>routePath<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token operator">:</span> AppContext<span class="token punctuation">,</span> next<span class="token operator">:</span> Next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
          <span class="token operator">...</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> responceRes <span class="token operator">=</span> <span class="token keyword">await</span> controller<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>$<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>responceRes <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> responceRes
          <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> Response<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;\u6CA1\u6709\u4F60\u8981\u8BBF\u95EE\u7684\u5185\u5BB9&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> err <span class="token operator">=</span> error <span class="token keyword">instanceof</span> <span class="token class-name">Error</span> <span class="token operator">?</span> error <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>error <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">500</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> Response<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">,</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// \u8FD9\u91CC\u53EF\u4EE5\u653E\u4E00\u4E9B\u540E\u7F6E\u5904\u7406\u7684\u4E2D\u95F4\u4EF6</span>

    <span class="token comment">// \u8BB0\u5F55\u4E00\u6761\u65E5\u5FD7</span>
    app<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LoggerNameSpace<span class="token punctuation">.</span>App<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\u2714 \u52A0\u8F7D ~[HTTP\u63A5\u53E3]~{</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}~{</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>routePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">importControllerFiles</span><span class="token punctuation">(</span><span class="token constant">CONTROLLER_ROOT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,47),S=s("\u8FD9\u90E8\u5206\u7684\u6E90\u7801\u5728\u3010"),N={href:"https://github.com/CavinHuang/koa-starter/blob/koa-router-1/src/server/application.ts",target:"_blank",rel:"noopener noreferrer"},I=s("initRoute.ts"),F=s("\u3011"),E=p(`<p>\u5728 application.ts \u4E2D\u4F7F\u7528\uFF1A</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">&#39;koa&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createServer<span class="token punctuation">,</span> Server <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;http&#39;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> LoggerNameSpace<span class="token punctuation">,</span> <span class="token constant">NOT_FOUND_APPLICATION_CONFIG</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/constants&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApplicationLogger<span class="token punctuation">,</span> createLogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./logger&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useMiddlewares <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./core/middlewares/useMiddlewares&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> loggerConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/config&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> initRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./router&#39;</span>

<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> AppContext<span class="token punctuation">,</span> Config <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/types&#39;</span>

<span class="token doc-comment comment">/**
 * \u5E94\u7528
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
  <span class="token comment">//...some code</span>

  <span class="token doc-comment comment">/**
   * \u6784\u9020\u51FD\u6570
   * <span class="token keyword">@param</span> <span class="token parameter">config</span>
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token operator">:</span> Config<span class="token punctuation">.</span>Application<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...some code</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mountRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//...some code</span>

  <span class="token doc-comment comment">/**
   * \u6302\u8F7D\u8DEF\u7531
   */</span>
  <span class="token function">mountRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initRouter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5230\u8FD9\u91CC\u6574\u4E2A\u5E94\u7528\u5E94\u8BE5\u5DF2\u7ECF\u53EF\u4EE5\u6B63\u5E38\u542F\u52A8\u4E86\uFF0C\u63A5\u4E0B\u6765\u6211\u4EEC\u5728 src/app.ts \u4E0B\u76F4\u63A5\u542F\u52A8\u670D\u52A1\uFF1A</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> application <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/config&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Application <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./server&#39;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Application</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B63\u5E38\u7684\u8BDD\u53EF\u4EE5\u770B\u5230\u5982\u4E0B\u7684\u65E5\u5FD7\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[2022-08-25T11:28:27.957] [13208] [INFO] - Application \u670D\u52A1\u5DF2\u8FD0\u884C\u5728http://127.0.0.1:4001 \u2714
[2022-08-25T11:28:28.023] [13208] [INFO] - Application \u2714 \u52A0\u8F7D ~[HTTP\u63A5\u53E3]~{get}~{/test/list}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5C1D\u8BD5\u8BBF\u95EE\uFF1A http://127.0.0.1:4001/api/test/list?name=1&amp;b=2 \u51FA\u73B0\u5982\u4E0B\u65E5\u5FD7\uFF0C\u8BF4\u660E\u6211\u4EEC\u7684\u670D\u52A1\u5DF2\u7ECF\u5B8C\u6574\u7684\u542F\u52A8\u4E86\uFF0C\u5E76\u4E14\u5728\u6839\u76EE\u5F55\u521B\u5EFA\u4E86logs\u76EE\u5F55</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[2022-08-25T17:05:28.511] [4968] [INFO] -
    ======&gt;
    timestamp: Thu Aug 25 2022 17:05:28 GMT+0800 (\u4E2D\u56FD\u6807\u51C6\u65F6\u95F4)
    request method: GET
    request url: /api/test/list
    request query: {&quot;name&quot;:&quot;1&quot;,&quot;b&quot;:&quot;2&quot;}
    request body: {}
    &lt;======
    response body: {&quot;data&quot;:{&quot;name&quot;:&quot;1&quot;,&quot;b&quot;:&quot;2&quot;},&quot;code&quot;:1,&quot;message&quot;:&quot;\u6210\u529F&quot;}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u603B\u7ED3\u4E0E\u9884\u544A" tabindex="-1"><a class="header-anchor" href="#\u603B\u7ED3\u4E0E\u9884\u544A" aria-hidden="true">#</a> \u603B\u7ED3\u4E0E\u9884\u544A</h2><p>\u672C\u8282\u4E3B\u8981\u662F\u719F\u6089\u5E76\u4F7F\u7528\u4E86koa\u3001\u4EE5\u53CAkoa\u63D2\u4EF6\u673A\u5236\uFF0C\u5E76\u5B8C\u6210\u4E86koa\u7684\u5E94\u7528\u5C01\u88C5\uFF0C\u5C01\u88C5\u5E76\u4F7F\u7528\u4E86\u591A\u4E2A\u4E2D\u95F4\u4EF6\uFF0C\u5B9E\u73B0\u7B80\u5355\u7684\u8DEF\u7531\u81EA\u52A8\u6CE8\u5165\u3002\u4E0B\u4E00\u7BC7\u5C06\u4E3A\u6574\u4E2A\u5E94\u7528\u5F15\u5165typescript\u88C5\u9970\u5668\uFF0C\u8BE6\u89E3typescript\u7684\u88C5\u9970\u5668\u4F7F\u7528\u65B9\u5F0F\uFF0C\u5E76\u4E3A\u6211\u4EEC\u7684koa\u8DEF\u7531\u81EA\u52A8\u6CE8\u5165\u6539\u9020\u6210\u88C5\u9970\u5668\u65B9\u5F0F\u3002</p><h2 id="github\u5730\u5740" tabindex="-1"><a class="header-anchor" href="#github\u5730\u5740" aria-hidden="true">#</a> GitHub\u5730\u5740</h2>`,11),H=s("\u672C\u7BC7\u3010"),j={href:"https://github.com/CavinHuang/koa-starter/tree/koa-router-1",target:"_blank",rel:"noopener noreferrer"},D=s("GitHub\u5730\u5740"),B=s("\u3011"),K=n("h2",{id:"\u535A\u5BA2",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u535A\u5BA2","aria-hidden":"true"},"#"),s(" \u535A\u5BA2")],-1),$=s("\u6B22\u8FCE\u5173\u6CE8\u5C0F\u535A\u5BA2\uFF0C\u6CA1\u5565\u7279\u70B9\u53EA\u6709\u4E00\u4E9B\u8BB0\u5F55\uFF0C\u8FD8\u4E0D\u5B8C\u5584\uFF0C\u6B63\u5728\u8C03\u6574\u4E2D"),G={href:"https://mrhuang.site",target:"_blank",rel:"noopener noreferrer"},U=s("\u535A\u5BA2\u5730\u5740");function W(V,J){const a=o("ExternalLinkIcon");return c(),i(l,null,[r,n("p",null,[k,n("a",d,[v,t(a)]),m]),b,g,n("p",null,[n("a",y,[w,t(a)]),f]),h,n("p",null,[x,n("a",_,[C,t(a)]),A,n("a",q,[L,t(a)])]),T,n("p",null,[P,n("a",R,[O,t(a)])]),M,n("p",null,[S,n("a",N,[I,t(a)]),F]),E,n("p",null,[H,n("a",j,[D,t(a)]),B]),K,n("p",null,[$,n("a",G,[U,t(a)])])],64)}var z=e(u,[["render",W],["__file","implement-a-koa-starter-from-scratch-2.html.vue"]]);export{z as default};
